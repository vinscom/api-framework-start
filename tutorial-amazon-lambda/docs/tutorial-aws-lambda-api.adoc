ifndef::toc[:toc: left]
ifndef::source-highlighter[:source-highlighter: pygments]
ifndef::pygments-linenums-mode[:pygments-linenums-mode: inline]
ifndef::imagesdir[:imagesdir: ./../../docs/images]

= Amazon Lambda API

.Serverless Architectures
[quote, Mike Roberts, https://martinfowler.com/articles/serverless.html]
Serverless architectures refer to applications that significantly depend on third-party
services (knows as Backend as a Service or "BaaS") or on custom code that's run in
ephemeral containers (Function as a Service or "FaaS"), the best known vendor host of
which currently is AWS Lambda.

API Framwork allows you to effortlessly run your API code as Lambda function in
AWS ecosystem. In this tutorial, we will setup, Amazon API Gateway to access Session
GET API (created as part of previous tutorial) and Amazon Lambda to execute Session
GET logic.

== Lambda Project Setup

We will be extending
https://docs.aws.amazon.com/lambda/latest/dg/create-deployment-pkg-zip-java.html[Amazon Lambda Example Project]
to run *Session GET API*. Example Lambda project is setup in Gradle. So, instead of
Maven, we will be using Gradle Project for this project.

== Gradle Project Files

=== settings.gradle
[source,groovy,linenums]
----
include::./../settings.gradle[]
----
This file only contain project name.

=== build.gradle
[source,groovy,linenums]
----
include::./../build.gradle[]
----
*api-framwork-amazon-lambda* is the required dependency. As we have already written
our Session API Code. We have include *tutorial-simple-get-api* project and configuration.

=== gradle.properties
[source,ini,linenums]
----
include::./../gradle.properties[]
----

Currently, Amazon Lambda only supports Java 1.8. In case you are having problem
compiling project (Because you have installed Java 1.9). You can specifically set JDK here.

== Create Lambda Function Code

[source,java,linenums]
----
include::./../src/main/java/in/erail/tutorial/amazon/lambda/SessionGetService.java[]
----

To create Lambda function. Simply, create Java class extended *AWSLambda* class.
And in constructor, pass service component path.

Your Lambda Function Is Ready!

=== Create Build

.Run
[source,sh,linenums]
----
gradle buildZip
----

Your Lambda deployment package will get created at
`build/distributions/tutorial-amazon-lambda.zip`

== Setup Lambda Function

. Go to AWS Management Console
. Goto Lambda
+
image::amazon-lambda/aws-lambda-home.png[]
Create lambda function using *Create Function*
. Create Function Screen
+
image::amazon-lambda/aws-lambda-author-from-scratch.png[]
  - *Name* : handleProcess
  - *Runtime* : Java 8
  - *Role** : We have already created role. Please create role if you don't have one
. Function Code
+
image::amazon-lambda/aws-lambda-config.png[]
  - *Function Package* : Upload _tutorial-amazon-lambda.zip_ file ( You can upload larger
  then 10MB file)
  - *Handle* : Enter _in.erail.tutorial.amazon.lambda.SessionGetService_ (Only class package
  and class name. No handle)
  - *Environment Variable*
    * *GLUE_LAYERS*  :  _./lib/api-framwork-1.0-SNAPSHOT-common-config.zip,./lib/tutorial-simple-get-api-1.0-SNAPSHOT-common-config.zip_
. Basic Settings
+
image::amazon-lambda/aws-lambda-basic-settings.png[]
Ensure you set memory to 192MB minimum. Or else you will get memory out of exception
. Create Test Event
+
image::amazon-lambda/aws-lambda-test.png[]
  - *Event Template* : API Gateway AWS Proxy
  - *Event Name* : SessionGETAPITestEvent
  - *Event Body* : Though body is POST message. Keep it as it is. Lambda function gets
  everything as JSON Object. Mapping between correct URL and Method type and
  Lambda function is managed at API Gateway level. Here we just want to test our
  Lambda function.
. Test Result
+
image::amazon-lambda/aws-lambda-test-result.png[]

== Setup API Gateway

Now our Lambda function is setup. Lets use Amazon API Gateway to expose our API.

. Create API
+
image::amazon-api-gateway/amazon-api-gateway-home.png[]

  - *API name* : _Tutorial Session Get API_
+
NOTE:  API Gateway supports Swagger 2.0. API Framwork supports Open API 3
specifications. As Open API 3 specification is becoming industry standard.
Expectation is that Amazon will start supporting Open API 3 in future. Till then,
you will have to create API manually.

. Create Resource
+
image::amazon-api-gateway/amazon-api-gateway-create-resource.png[]
Our API will be accessible on /session URL.

. Configure Resource
+
image::amazon-api-gateway/amazon-api-gateway-resource-config.png[]
  - *Resource Name* : _session_ (This can any any name)
  - *Resource Path* : URL _/session_

. Create Action
+
image::amazon-api-gateway/amazon-api-gateway-get-action.png[]
  - *GET Action* : Create GET action. Configure action as per image.

. Save Action
+
image::amazon-api-gateway/amazon-api-gateway-get-action-save.png[]

. Method Setup
+
image::amazon-api-gateway/amazon-api-gateway-get-action-created.png[]
Final API setup

. Test API
+
image::amazon-api-gateway/amazon-api-gateway-get-action-test.png[]

Amazon Lambda based API is working!!!
